<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="å­æœ‹"><meta name="copyright" content="å­æœ‹"><meta name="generator" content="Hexo 5.3.0"><meta name="theme" content="hexo-theme-yun"><title>åŸºäº Go å®ç°ä»¿ gin æ¡†æ¶ | null</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"example.com","root":"/","title":["W","E","L","C","O","M","E"],"version":"1.4.0","mode":"auto","copycode":true,"page":{"isPost":true},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><meta name="description" content="github æºç ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;ITAleftback&#x2F;Go-web- httprouterçœ‹å®Œæœ‰å…³ä»‹ç»ï¼Œå‘ç°è¯¸å¤šçš„webæ¡†æ¶éƒ½ä½¿ç”¨è¿™ä¸ªhttprouteræ¥å¼¥è¡¥éƒ¨åˆ†net&#x2F;httpçš„ä¸è¶³ã€‚çœ‹äº†ä¸‹åŸç†ï¼Œç©¶å…¶åŸå› å…¶å®å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªå‰ç¼€æ ‘æ¥ç®¡ç†è¯·æ±‚çš„URLã€‚ httprouterä¸­, å¯¹äºæ¯ç§æ–¹æ³•éƒ½æœ‰ä¸€é¢—treeæ¥ç®¡ç†, ä¾‹å¦‚æ‰€æœ‰çš„GETæ–¹æ³•å¯¹åº”çš„è¯·æ±‚ä¼šæœ‰ä¸€é¢—treeç®¡ç†,">
<meta property="og:type" content="article">
<meta property="og:title" content="åŸºäº Go å®ç°ä»¿ gin æ¡†æ¶">
<meta property="og:url" content="http://example.com/2021/06/11/%E5%9F%BA%E4%BA%8E%20Go%20%E5%AE%9E%E7%8E%B0%E4%BB%BF%20gin%20%E6%A1%86%E6%9E%B6/index.html">
<meta property="og:site_name">
<meta property="og:description" content="github æºç ï¼šhttps:&#x2F;&#x2F;github.com&#x2F;ITAleftback&#x2F;Go-web- httprouterçœ‹å®Œæœ‰å…³ä»‹ç»ï¼Œå‘ç°è¯¸å¤šçš„webæ¡†æ¶éƒ½ä½¿ç”¨è¿™ä¸ªhttprouteræ¥å¼¥è¡¥éƒ¨åˆ†net&#x2F;httpçš„ä¸è¶³ã€‚çœ‹äº†ä¸‹åŸç†ï¼Œç©¶å…¶åŸå› å…¶å®å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªå‰ç¼€æ ‘æ¥ç®¡ç†è¯·æ±‚çš„URLã€‚ httprouterä¸­, å¯¹äºæ¯ç§æ–¹æ³•éƒ½æœ‰ä¸€é¢—treeæ¥ç®¡ç†, ä¾‹å¦‚æ‰€æœ‰çš„GETæ–¹æ³•å¯¹åº”çš„è¯·æ±‚ä¼šæœ‰ä¸€é¢—treeç®¡ç†,">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-06-11T11:33:50.000Z">
<meta property="article:modified_time" content="2021-06-11T15:18:12.381Z">
<meta property="article:author" content="å­æœ‹">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="gin">
<meta name="twitter:card" content="summary"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="å­æœ‹"><img width="96" loading="lazy" src="/images/Jxp.jpg" alt="å­æœ‹"><span class="site-author-status" title="ä¸æƒ³ä¸Šå­¦">ğŸ˜­</span></a><div class="site-author-name"><a href="/about/">å­æœ‹</a></div><a class="site-name" href="/about/site.html"></a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">6</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://github.com/ITAleftback" title="å°ç ´ç«™"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="mailto:1808321138@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/ITAleftback" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#github-%E6%BA%90%E7%A0%81%EF%BC%9A"><span class="toc-number">1.</span> <span class="toc-text">github æºç ï¼š</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#httprouter"><span class="toc-number">2.</span> <span class="toc-text">httprouter</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">3.1.</span> <span class="toc-text">è·¯ç”±</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">3.2.</span> <span class="toc-text">ä¸­é—´ä»¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-number">3.3.</span> <span class="toc-text">åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recovery"><span class="toc-number">3.4.</span> <span class="toc-text">Recovery</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.</span> <span class="toc-text">é‡åˆ°çš„é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E4%BA%92%E7%9B%B8%E8%B0%83%E7%94%A8"><span class="toc-number">4.1.</span> <span class="toc-text">1.ç»“æ„ä½“çš„äº’ç›¸è°ƒç”¨</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://example.com/2021/06/11/%E5%9F%BA%E4%BA%8E%20Go%20%E5%AE%9E%E7%8E%B0%E4%BB%BF%20gin%20%E6%A1%86%E6%9E%B6/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="å­æœ‹"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">åŸºäº Go å®ç°ä»¿ gin æ¡†æ¶<a class="post-edit-link" href="https://github.com/YunYouJun/yunyoujun.github.io/tree/hexo/source/_posts/åŸºäº Go å®ç°ä»¿ gin æ¡†æ¶.md" target="_blank" title="Edit this post" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2021-06-11 19:33:50" itemprop="dateCreated datePublished" datetime="2021-06-11T19:33:50+08:00">2021-06-11</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/Go/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Go</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/Go/gin/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">gin</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/Go/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Go</span></a><a class="tag" href="/tags/gin/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">gin</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h1 id="github-æºç ï¼š"><a href="#github-æºç ï¼š" class="headerlink" title="github æºç ï¼š"></a>github æºç ï¼š</h1><p><a target="_blank" rel="noopener" href="https://github.com/ITAleftback/Go-web-">https://github.com/ITAleftback/Go-web-</a></p>
<h1 id="httprouter"><a href="#httprouter" class="headerlink" title="httprouter"></a>httprouter</h1><p>çœ‹å®Œæœ‰å…³ä»‹ç»ï¼Œå‘ç°è¯¸å¤šçš„webæ¡†æ¶éƒ½ä½¿ç”¨è¿™ä¸ªhttprouteræ¥å¼¥è¡¥éƒ¨åˆ†net/httpçš„ä¸è¶³ã€‚çœ‹äº†ä¸‹åŸç†ï¼Œç©¶å…¶åŸå› å…¶å®å°±æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªå‰ç¼€æ ‘æ¥ç®¡ç†è¯·æ±‚çš„URLã€‚</p>
<p>httprouterä¸­, å¯¹äºæ¯ç§æ–¹æ³•éƒ½æœ‰ä¸€é¢—treeæ¥ç®¡ç†, ä¾‹å¦‚æ‰€æœ‰çš„GETæ–¹æ³•å¯¹åº”çš„è¯·æ±‚ä¼šæœ‰ä¸€é¢—treeç®¡ç†, æ‰€æœ‰çš„POSTåŒæ ·å¦‚æ­¤. å…ˆæ¥çœ‹çœ‹router</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type Router struct &#123;</span><br><span class="line">   trees map[string]*node</span><br><span class="line">   </span><br><span class="line">   RedirectTrailingSlash bool</span><br><span class="line">   </span><br><span class="line">   RedirectFixedPath bool</span><br><span class="line">   </span><br><span class="line">   HandleMethodNotAllowed bool</span><br><span class="line">  </span><br><span class="line">   HandleOPTIONS bool</span><br><span class="line"></span><br><span class="line">   GlobalOPTIONS http.Handler</span><br><span class="line"></span><br><span class="line">   globalAllowed string</span><br><span class="line"></span><br><span class="line">   NotFound http.Handler</span><br><span class="line"></span><br><span class="line">   MethodNotAllowed http.Handler</span><br><span class="line"></span><br><span class="line">   PanicHandler func(http.ResponseWriter, *http.Request, interface&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ç»“æ„ä¸­, trees map[string]*nodeä»£è¡¨çš„ä¸€ä¸ªæ£®æ—, é‡Œé¢æœ‰ä¸€é¢—GET tree, POST treeâ€¦</p>
<p>è€Œæˆ‘åŸæœ¬æƒ³åˆ°çš„æ˜¯ç”¨mapåµŒå¥—ä½¿å¾—methodï¼Œuriï¼ŒhandleFuncéƒ½æŒ‡å®šèµ·æ¥ï¼Œå…‰æ˜¯è¿™æ ·è‚¯å®šæ˜¯å¤ªç®€å•äº†ã€‚</p>
<p>å†æ¥çœ‹çœ‹node</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type node struct &#123;</span><br><span class="line">   &#x2F;&#x2F; ä¿å­˜è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„URLè·¯å¾„</span><br><span class="line">   path      string</span><br><span class="line">  </span><br><span class="line">   wildChild bool</span><br><span class="line">   nType     nodeType</span><br><span class="line">   maxParams uint8</span><br><span class="line">   priority  uint32</span><br><span class="line">   indices   string</span><br><span class="line">   children  []*node</span><br><span class="line">   &#x2F;&#x2F;ä¸€ç§è¯·æ±‚å‡½æ•°</span><br><span class="line">   handle    Handle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å­¦è¯†æµ…é™‹çš„æˆ‘åªèƒ½çœ‹æ‡‚äº†pathä¸handleã€‚å¦‚ä¸Šæ³¨é‡Šæ‰€ç¤ºã€‚</p>
<p>äºæ˜¯æˆ‘å¤§æ¦‚ä¼¼æ‡‚éæ‡‚çš„æ‡‚äº†è¿‡ç¨‹ã€‚ç”¨mapä¿å­˜methodï¼Œè€Œæ¯ä¸ªmethodå¯¹åº”ä¸€ä¸ªæ ‘ï¼Œè¿™ä¸ªæ ‘ä¸Šæœ‰è·¯å¾„åŠå…¶å¯¹åº”çš„handleã€‚</p>
<p><strong>æ‰€ä»¥è¯´æ¡†æ¶ä¼šç”Ÿæˆå‡ æ£µåŸºæ•°æ ‘ï¼Œåˆ†åˆ«å¯¹åº”http methodã€‚æ ‘ç»“æ„å¯¹åº”pathçš„æ ‘çŠ¶å½¢æ€ï¼Œæ¯ä¸ªpathä¼šmapåˆ°ä¸€ä¸ªHandlerFuncã€‚è¿™æ ·ï¼Œåœ¨æ¥æ”¶åˆ°httpè¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæ‰¾åˆ°è¯¥è¯·æ±‚å¯¹åº”çš„http methodæ ‘ï¼Œå†æ ¹æ®URLçš„pathæ‰¾åˆ°æ³¨å†Œå¥½çš„HandlerFuncã€‚HandlerFuncå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘éœ€è¦ginçš„ä½¿ç”¨è€…å€ŸåŠ©Contextç»“æ„è‡ªè¡Œå¤„ç†ã€‚</strong></p>
<p>é‚£åˆ†ç»„è·¯ç”±åº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿæˆ‘åˆè·‘å»çœ‹äº†çœ‹ginçš„æºç ï¼Œå‘ç°é‡Œé¢æœ‰ä¸ªRouterGroupä¸Engineäº’ç›¸ç»§æ‰¿ã€‚è€ŒRouterGroupé¡¾åæ€ä¹‰åˆ™æ˜¯æ‹¿æ¥å­˜æ”¾çš„åœ°æ–¹ã€‚äºæ˜¯æˆ‘æƒ³åˆ°äº†ï¼Œç”¨RouterGroupæ¥å­˜è·¯å¾„ã€‚å¦‚æœæ˜¯ç›´æ¥å®ç°è·¯ç”±ï¼Œåˆ™ç›´æ¥å‘prefixæ·»åŠ è·¯å¾„ã€‚å¦‚æœæ˜¯åˆ†ç»„è·¯ç”±ï¼Œåˆ™å¯ä»¥å…ˆä¿å­˜å‰é¢çš„è·¯å¾„ï¼Œç„¶ååé¢å†é€šè¿‡æŸä¸ªå‡½æ•°è®²å‰é¢çš„è·¯å¾„ä¸åé¢æ³¨å†Œçš„è·¯å¾„è¿›è¡Œæ•´åˆï¼Œåœ¨å°†å…¶èµ‹ç»™prefixã€‚</p>
<h1 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h1><h2 id="è·¯ç”±"><a href="#è·¯ç”±" class="headerlink" title="è·¯ç”±"></a>è·¯ç”±</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å¼€è·¯ç”±ç»„çš„ç»“æ„ä½“</span><br><span class="line">type RouterGroup struct &#123;</span><br><span class="line">   Handlers HandlerFunc&#x2F;&#x2F;å­˜æ”¾æ¥å£å‡½æ•°</span><br><span class="line">   prefix string&#x2F;&#x2F;å­˜æ”¾è·¯å¾„</span><br><span class="line"></span><br><span class="line">   engine *Engine</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">type Engine struct &#123;</span><br><span class="line">   &#x2F;&#x2F;ç»§æ‰¿ä¸Šé¢çš„ç»“æ„ä½“æ–¹ä¾¿ç”¨ä¸€äº›ä¸œè¥¿</span><br><span class="line">   *RouterGroup</span><br><span class="line">   router *httprouter.Router</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Engineé‡Œçš„routerï¼Œæˆ‘åŸæœ¬æƒ³åˆ°çš„æ˜¯ç”¨mapåµŒå¥—å®ç°ï¼Œä¸¤å±‚åµŒå¥—ï¼Œmethodã€è·¯å¾„ä»¥åŠæ¥å£å‡½æ•°å¯¹åº”èµ·æ¥ã€‚</p>
<p>è€Œæˆ‘å°è¯•ä½¿ç”¨äº†ä¸‹httprouteræ¥ç›´æ¥æ³¨å†Œè·¯ç”±ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:&#x3D;httprouter.New()</span><br><span class="line">a.GET(&quot;&#x2F;test&quot;,hello)</span><br></pre></td></tr></table></figure>
<p>å‘ç°æ˜¯å¯è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘å¯ä»¥ç›´æ¥ä½¿ç”¨httprouteré‡Œçš„routerç»“æ„ä½“ã€‚</p>
<p>ç„¶åæ˜¯å®šä¹‰çš„Contextæ•°æ®ï¼Œç›¸å…³æ³¨é‡Šå·²å†™ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Context</span><br><span class="line">type Context struct &#123;</span><br><span class="line">   Req *http.Request&#x2F;&#x2F;å‘é€è¯·æ±‚</span><br><span class="line">   Writer http.ResponseWriter&#x2F;&#x2F;æœåŠ¡å™¨å“åº”</span><br><span class="line">   Params httprouter.Params&#x2F;&#x2F;å‚æ•°æ”¾è¿™</span><br><span class="line">   &#x2F;&#x2F;Param map[string]string&#x2F;&#x2F;</span><br><span class="line">   </span><br><span class="line">   handlers HandlerFunc&#x2F;&#x2F;</span><br><span class="line">   engine *Engine</span><br><span class="line">   index int8&#x2F;&#x2F;ç”¨æ¥éå† åˆ‡ç‰‡</span><br><span class="line">   Errors   []ErrorMsg&#x2F;&#x2F;é”™è¯¯ä¿¡æ¯</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type HandlerFunc func(*Context)</span><br></pre></td></tr></table></figure>
<p>ç„¶åä»æœ€ç®€å•çš„å¼€å§‹ï¼ŒDefalutã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func Defalut() *Engine&#123;</span><br><span class="line">   engine:&#x3D;&amp;Engine&#123;&#125;</span><br><span class="line">   engine.RouterGroup&#x3D;&amp;RouterGroup&#123;</span><br><span class="line">      Handlers: nil,</span><br><span class="line">      prefix:  &quot;&quot;,</span><br><span class="line"></span><br><span class="line">      engine:  engine,</span><br><span class="line">   &#125;</span><br><span class="line">   &#x2F;&#x2F;ç”¨è¿™ä¸ªç”Ÿæˆ*router è·¯ç”±æŒ‡é’ˆ</span><br><span class="line">   engine.router&#x3D;httprouter.New()</span><br><span class="line">   return engine</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>defalutåœ¨äºå°†Engineåˆå§‹åŒ–ç„¶åè¿”å›ï¼Œæ–¹ä¾¿åé¢çš„ä¸€äº›å¦‚å†™ä¸­é—´ä»¶çš„æ“ä½œã€‚å€¼å¾—ä¸€æçš„æ˜¯httprouter.newï¼Œå…¶è¿”å›çš„æ­£æ˜¯Routerç»“æ„ä½“ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘å°±å¯ä»¥å®ç°ä¸Šé¢è¯´çš„å‰ç¼€æ ‘ç®¡ç†URLã€‚</p>
<p>ç„¶åæ˜¯æœ€ç®€å•çš„çš„å¯åŠ¨å‡½æ•°ï¼Œå°±æ˜¯æŠŠç›‘å¬å‡½æ•°ç®€ç®€å•å•çš„å°è£…äº†ä¸€ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å…ˆæŠŠæœ€ç®€å•çš„å†™äº†ï¼Œå¯åŠ¨å‡½æ•°ï¼Œåªæ˜¯æŠŠhttp.ListenAndServeå°è£…ä¸€ä¸‹</span><br><span class="line">func (engine *Engine)Run(addr string)&#123;</span><br><span class="line">   _ &#x3D; http.ListenAndServe(addr, engine)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯è¿™é‡Œæ›¾é‡åˆ°è¿‡ä¸€ä¸ªå°é—®é¢˜ã€‚engineä¼ å…¥è¿™ä¸ªå‚æ•°æ—¶æ˜¯ä¼šæŠ¥é”™çš„ï¼Œæˆ‘å¾ˆçº³é—·å»æŸ¥çœ‹äº†ç›‘å¬å‡½æ•°çš„æºç ï¼Œå‘ç°ç¬¬äºŒä¸ªå‚æ•°çš„å½¢å¼æ˜¯ä¸€ä¸ªæ¥å£</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Handler interface &#123;</span><br><span class="line">   ServeHTTP(ResponseWriter, *Request)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡Œé¢æœ‰ä¸ªæ–¹æ³•ServeHTTPï¼Œæ‰€ä»¥åªè¦engineå®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥å½“å‚æ•°äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func (engine *Engine) ServeHTTP(w http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">   engine.router.ServeHTTP(w, req)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆï¼Œè¿™ä¸ªå‡½æ•°åˆåº”è¯¥æ‹¿æ¥å¹²å˜›çš„ï¼Ÿæˆ‘æƒ³äº†ä¸‹åº”è¯¥æ˜¯å°†å…ˆå‰æ³¨å†Œçš„è·¯ç”±å®ç°æ¥å£ï¼ŒServeHTTPå¯ä»¥å°†engineä¼ ç»™ListenAndServeï¼Œç„¶åä¸­é—´æ‰€æœ‰çš„è·¯ç”±ç®¡ç†ï¼Œpathå¯¹åº”çš„handlerç­‰ï¼Œéƒ½ç”±ServeHTTPå»è°ƒç”¨ç›¸åº”çš„å®ç°å‡½æ•°</p>
<p>è€Œæˆ‘ä¸ºäº†æ–¹ä¾¿å°±ç›´æ¥è°ƒç”¨äº†httprouteré‡Œçš„ServeHTTP</p>
<p>ä¸‹é¢æ˜¯httprouteré‡Œçš„ServeHTTPä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ServeHTTP makes the router implement the http.Handler interface.</span><br><span class="line">func (r *Router) ServeHTTP(w http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">   if r.PanicHandler !&#x3D; nil &#123;</span><br><span class="line">      defer r.recv(w, req)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   path :&#x3D; req.URL.Path</span><br><span class="line"></span><br><span class="line">   if root :&#x3D; r.trees[req.Method]; root !&#x3D; nil &#123;</span><br><span class="line">      if handle, ps, tsr :&#x3D; root.getValue(path); handle !&#x3D; nil &#123;</span><br><span class="line">         handle(w, req, ps)</span><br><span class="line">         return</span><br><span class="line">      &#125; else if req.Method !&#x3D; http.MethodConnect &amp;&amp; path !&#x3D; &quot;&#x2F;&quot; &#123;</span><br><span class="line">         code :&#x3D; 301 &#x2F;&#x2F; Permanent redirect, request with GET method</span><br><span class="line">         if req.Method !&#x3D; http.MethodGet &#123;</span><br><span class="line">            &#x2F;&#x2F; Temporary redirect, request with same method</span><br><span class="line">            &#x2F;&#x2F; As of Go 1.3, Go does not support status code 308.</span><br><span class="line">            code &#x3D; 307</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         if tsr &amp;&amp; r.RedirectTrailingSlash &#123;</span><br><span class="line">            if len(path) &gt; 1 &amp;&amp; path[len(path)-1] &#x3D;&#x3D; &#39;&#x2F;&#39; &#123;</span><br><span class="line">               req.URL.Path &#x3D; path[:len(path)-1]</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">               req.URL.Path &#x3D; path + &quot;&#x2F;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            http.Redirect(w, req, req.URL.String(), code)</span><br><span class="line">            return</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         &#x2F;&#x2F; Try to fix the request path</span><br><span class="line">         if r.RedirectFixedPath &#123;</span><br><span class="line">            fixedPath, found :&#x3D; root.findCaseInsensitivePath(</span><br><span class="line">               CleanPath(path),</span><br><span class="line">               r.RedirectTrailingSlash,</span><br><span class="line">            )</span><br><span class="line">            if found &#123;</span><br><span class="line">               req.URL.Path &#x3D; string(fixedPath)</span><br><span class="line">               http.Redirect(w, req, req.URL.String(), code)</span><br><span class="line">               return</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   if req.Method &#x3D;&#x3D; http.MethodOptions &amp;&amp; r.HandleOPTIONS &#123;</span><br><span class="line">      &#x2F;&#x2F; Handle OPTIONS requests</span><br><span class="line">      if allow :&#x3D; r.allowed(path, http.MethodOptions); allow !&#x3D; &quot;&quot; &#123;</span><br><span class="line">         w.Header().Set(&quot;Allow&quot;, allow)</span><br><span class="line">         if r.GlobalOPTIONS !&#x3D; nil &#123;</span><br><span class="line">            r.GlobalOPTIONS.ServeHTTP(w, req)</span><br><span class="line">         &#125;</span><br><span class="line">         return</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; else if r.HandleMethodNotAllowed &#123; &#x2F;&#x2F; Handle 405</span><br><span class="line">      if allow :&#x3D; r.allowed(path, req.Method); allow !&#x3D; &quot;&quot; &#123;</span><br><span class="line">         w.Header().Set(&quot;Allow&quot;, allow)</span><br><span class="line">         if r.MethodNotAllowed !&#x3D; nil &#123;</span><br><span class="line">            r.MethodNotAllowed.ServeHTTP(w, req)</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">            http.Error(w,</span><br><span class="line">               http.StatusText(http.StatusMethodNotAllowed),</span><br><span class="line">               http.StatusMethodNotAllowed,</span><br><span class="line">            )</span><br><span class="line">         &#125;</span><br><span class="line">         return</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; Handle 404</span><br><span class="line">   if r.NotFound !&#x3D; nil &#123;</span><br><span class="line">      r.NotFound.ServeHTTP(w, req)</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">      http.NotFound(w, req)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹ç€æŒºèŠ±çœ¼çš„ï¼Œä½†ä»”ç»†ä¸€çœ‹æœ€é‡è¦çš„åœ¨äº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">path :&#x3D; req.URL.Path</span><br><span class="line"></span><br><span class="line">if root :&#x3D; r.trees[req.Method]; root !&#x3D; nil &#123;</span><br><span class="line">   if handle, ps, tsr :&#x3D; root.getValue(path); handle !&#x3D; nil &#123;</span><br><span class="line">      handle(w, req, ps)</span><br><span class="line">      return</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæ‹¿å‡ºhttpè¯·æ±‚é‡Œé¢çš„methodå’Œpathè·¯å¾„ï¼Œç„¶ååˆ©ç”¨getValueå‡½æ•°è¿”å›ä¸€ä¸ªç»™å®šè·¯å¾„çš„handlerä¹Ÿå°±æ˜¯å®ç°æ¥å£ä¼ ç»™ListenAndServeã€‚</p>
<p>å¦‚æ­¤ä¸€æ¥ï¼ŒServeHTTPå®Œæˆäº†ä»–çš„åŠŸèƒ½ï¼Œå‡½æ•°å¯ä»¥å¼€å§‹ç›‘å¬ã€‚</p>
<p>ç„¶åæ˜¯åˆ†ç»„è·¯ç”±</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; å¦‚æœæ˜¯å¼€è·¯ç”±ç»„ï¼Œåˆ™ç”¨åˆ°è¿™ä¸ªæ–¹æ³•</span><br><span class="line">func (group *RouterGroup) Group(component string) *RouterGroup &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   return &amp;RouterGroup&#123;</span><br><span class="line">      Handlers: nil,</span><br><span class="line">      prefix:  component,</span><br><span class="line">      engine:  group.engine,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ†ç»„è·¯ç”±ä¸æ™®é€šçš„è·¯ç”±æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæ— éä¸è¿‡æ˜¯éœ€è¦å°†å‰ç¼€çš„è·¯å¾„ä¸åé¢åŠ å…¥çš„è·¯å¾„åˆå¹¶èµ·æ¥è¿›è¡Œæ³¨å†Œã€‚æ‰€ä»¥ä¸ºæ­¤æˆ‘å†™äº†RouterGroupçš„ç»“æ„ä½“ï¼Œprefixå°±æ˜¯å­˜æ”¾è·¯å¾„ï¼ŒHandlersåˆ™æ˜¯ä¸ºäº†æ”¾ç½®ä¸­é—´ä»¶åŠå…¶æ¥å£å‡½æ•°</p>
<p>è€ŒGroupè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¾è€Œæ˜“è§äº†ï¼Œå°†è·¯å¾„ä¿å­˜åˆ°prefixï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„RouterGroupã€‚</p>
<p>ç„¶åæ˜¯å†™handleï¼Œhandleçš„ä½œç”¨æ˜¯å°†method ï¼Œuri ä»¥åŠä¸­é—´ä»¶è¿˜æœ‰æ¥å£å‡½æ•°å¯¹åº”èµ·æ¥ç„¶ååŠ å…¥åˆ°routerçš„è·¯ç”±é…ç½®ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func (group *RouterGroup) Handle(method, uri string, handler HandlerFunc) &#123;</span><br><span class="line">   &#x2F;&#x2F;åŠ ä¸ŠåŸæœ¬è·¯ç”±ç»„çš„ è·¯å¾„</span><br><span class="line">   uris:&#x3D; path.Join(group.prefix, uri)</span><br><span class="line"> </span><br><span class="line">   &#x2F;&#x2F;å°† æ•´åˆçš„è·¯å¾„ è¿˜æœ‰ handler æ·»åŠ åˆ°httprouterå»</span><br><span class="line">   group.engine.router.Handle(method, uris, func(w http.ResponseWriter, req *http.Request, params httprouter.Params) &#123;</span><br><span class="line">      group.NewContext(w, req, params, handler).Next()</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶ï¼Œurisæ­£æ˜¯å°†è·¯ç”±ç»„çš„è·¯å¾„ä¸æ–°æ³¨å†Œçš„è·¯å¾„è¿›è¡Œæ•´åˆåçš„äº§ç‰©ã€‚</p>
<p>group.engine.router.Handleæ˜¯å¹²å˜›çš„ï¼Ÿä¸Šæ–‡æåˆ°è¿‡ï¼ŒHandleå‡½æ•°ä½œç”¨æ˜¯å°†methodï¼Œuriä»¥åŠå¯¹åº”çš„æ¥å£å‡½æ•°å¯¹åº”èµ·æ¥ï¼Œä¸€å¼€å§‹æˆ‘å°è¯•ç”¨mapçš„æ–¹å¼å°†å…¶å¯¹åº”ï¼Œä½†æ˜¯å½“åŠ å…¥ä¸­é—´ä»¶çš„æ—¶å€™ï¼Œå¯¹åº”çš„åˆä¸åªæœ‰æ¥å£å‡½æ•°ï¼Œä¸çŸ¥æ€ä¹ˆåŠçš„æˆ‘åˆå»æ‰¾æˆ‘çš„é‡‘é’¥åŒ™äº†ã€‚æˆ‘å‘ç°é‡Œé¢è¿˜æœ‰ä¸€ä¸ªHandleï¼Œæ‰€ä»¥æˆ‘åˆæ˜¯è°ƒç”¨äº†httprouteré‡Œçš„Handleã€‚</p>
<p>httprouteré‡ŒHandleçš„æºç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func (r *Router) Handle(method, path string, handle Handle) &#123;</span><br><span class="line">   if len(path) &lt; 1 || path[0] !&#x3D; &#39;&#x2F;&#39; &#123;</span><br><span class="line">      panic(&quot;path must begin with &#39;&#x2F;&#39; in path &#39;&quot; + path + &quot;&#39;&quot;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   if r.trees &#x3D;&#x3D; nil &#123;</span><br><span class="line">      r.trees &#x3D; make(map[string]*node)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   root :&#x3D; r.trees[method]</span><br><span class="line">   if root &#x3D;&#x3D; nil &#123;</span><br><span class="line">      root &#x3D; new(node)</span><br><span class="line">      r.trees[method] &#x3D; root</span><br><span class="line"></span><br><span class="line">      r.globalAllowed &#x3D; r.allowed(&quot;*&quot;, &quot;&quot;)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   root.addRoute(path, handle)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾è€Œæ˜“è§ï¼Œæœ€é‡è¦çš„ä»£ç å—æ˜¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root :&#x3D; r.trees[method]</span><br><span class="line">if root &#x3D;&#x3D; nil &#123;</span><br><span class="line">   root &#x3D; new(node)</span><br><span class="line">   r.trees[method] &#x3D; root</span><br><span class="line"></span><br><span class="line">   r.globalAllowed &#x3D; r.allowed(&quot;*&quot;, &quot;&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root.addRoute(path, handle)</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå°±æ˜¯å°†ä¼ å…¥çš„methodä»¥åŠpathä»¥åŠhandleå¯¹åº”ã€‚å…ˆæ˜¯åˆ©ç”¨mapä¿å­˜æ–¹æ³•ï¼Œç„¶ååœ¨åˆ©ç”¨addRouteå‡½æ•°è¿›è¡Œå¯¹åº”ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">group.engine.router.Handle(method, uris, func(w http.ResponseWriter, req *http.Request, params httprouter.Params) &#123;</span><br><span class="line">   group.NewContext(w, req, params, handlers).Next()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥åœ¨è¿™ä¸ªä»£ç å—é‡Œï¼Œä¼ å…¥çš„æ­£åº”è¯¥æ˜¯methodï¼Œuriï¼Œä»¥åŠæ¥å£å‡½æ•°ã€‚è€Œç¬¬ä¸‰ä¸ªå‚æ•°å½¢å¼ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type Handle func(http.ResponseWriter, *http.Request, Params)</span><br></pre></td></tr></table></figure>
<p>Handleæ˜¯ä¸€ä¸ªå¯ä»¥æ³¨å†Œåˆ°è·¯ç”±ä»¥å¤„ç†HTTPè¯·æ±‚çš„å‡½æ•°</p>
<p>æ‰€ä»¥æˆ‘ä¼ å…¥ç¬¬ä¸‰ä¸ªåŒ¿åå‡½æ•°åŒæ—¶åˆ›å»ºäº†Newcontextã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func (group *RouterGroup) NewContext(w http.ResponseWriter, req *http.Request, params httprouter.Params, handlers []HandlerFunc) *Context &#123;</span><br><span class="line">   return &amp;Context&#123;</span><br><span class="line">      Writer:  w,</span><br><span class="line">      Req:     req,</span><br><span class="line">      index:   -1,&#x2F;&#x2F; ç¬¬ä¸€æ¬¡å°±è®¾ç½®-1  è°ƒç”¨æ—¶åŒæ—¶ä¼šè°ƒç”¨next++</span><br><span class="line">      engine:  group.engine,</span><br><span class="line">      Params:  params,</span><br><span class="line">      handlers: handlers,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯èƒ½ä½ ä¼šæ³¨æ„åˆ°Newcontextåé¢è¿˜æœ‰ä¸€ä¸ªNextã€‚</p>
<p>è¿™ä¸ªå‡½æ•°æ­£æ˜¯æˆ‘å‰é¢æåˆ°çš„è°ƒç”¨handlerçš„å‡½æ•°ï¼Œä¸Šæºç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func (c *Context) Next() &#123;</span><br><span class="line">	c.handler(c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸­é—´ä»¶"><a href="#ä¸­é—´ä»¶" class="headerlink" title="ä¸­é—´ä»¶"></a>ä¸­é—´ä»¶</h2><p>ä¸‹é¢è®²è®²ä¸­é—´ä»¶çš„å®ç°ã€‚</p>
<p>å…ˆä¸Šä»£ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä¸­é—´ä»¶æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯æŠŠå‡½æ•°è½¬æˆHandlerFuncï¼Œç„¶ååœ¨ä¸­é—´ä»¶é‡Œè°ƒç”¨ServeHTTP</span><br><span class="line">&#x2F;&#x2F;ä¸­é—´ä»¶ï¼Œå°†å¿ƒçš„ä¸­é—´ä»¶åŠ å…¥åˆ°äº†groupçš„handlerçš„sliceä¸­</span><br><span class="line">func (group *RouterGroup) Use(middlewares ...HandlerFunc) &#123;</span><br><span class="line">   group.Handlers &#x3D; append(group.Handlers, middlewares...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¾ˆç®€å•ï¼Œåªæ˜¯å°†ä¼ å…¥ä»»æ„çš„handlefuncè¿›è¡Œæ•´åˆç„¶åè¿”å›åˆ°Routergroupé‡Œé¢çš„handleåˆ‡ç‰‡ã€‚</p>
<p>å…¶å®ä¸­é—´ä»¶çš„åŸç†åœ¨äºï¼Œå®ƒæ˜¯åŒæ¥å£å‡½æ•°ä¸€æ ·çš„å‡½æ•°ï¼Œä½†å¦‚æœéœ€è¦åœ¨æ¥å£å‡½æ•°ä¹‹å‰å®ç°ã€‚å¾ˆå®¹æ˜“å°±æƒ³åˆ°åˆ‡ç‰‡ï¼Œå…ˆåŠ å…¥çš„æ”¾å‰é¢ï¼ŒååŠ å…¥çš„æ”¾åé¢ï¼Œç„¶åå†ä¾æ¬¡è°ƒç”¨ï¼Œå¦‚æ­¤è¾¾åˆ°æ•ˆæœã€‚</p>
<p>æ‰€ä»¥è¦æ”¹çš„åœ°æ–¹å°±æœ‰å¾ˆå¤šäº†ã€‚</p>
<p>å› ä¸ºæ˜¯è¦ç”¨åˆ°åˆ‡ç‰‡ï¼Œå­˜æ”¾HandlerFuncæ”¹ä¸ºåˆ‡ç‰‡ï¼Œç”¨æ¥æ”¾ç½®ä¸­é—´ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Context</span><br><span class="line">type Context struct &#123;</span><br><span class="line">   Req *http.Request&#x2F;&#x2F;å‘é€è¯·æ±‚</span><br><span class="line">   Writer http.ResponseWriter&#x2F;&#x2F;æœåŠ¡å™¨å“åº”</span><br><span class="line">   Params httprouter.Params&#x2F;&#x2F;å‚æ•°æ”¾è¿™</span><br><span class="line">   &#x2F;&#x2F;Param map[string]string&#x2F;&#x2F;æ‹¿å‚æ•°</span><br><span class="line">   Keys map[string]interface&#123;&#125;&#x2F;&#x2F;ç”¨mapå­˜å‚¨ä¸­é—´å˜é‡</span><br><span class="line">   handlers []HandlerFunc&#x2F;&#x2F;</span><br><span class="line">   engine *Engine</span><br><span class="line">   index int8&#x2F;&#x2F;ç”¨æ¥éå† åˆ‡ç‰‡</span><br><span class="line">   Errors   []ErrorMsg&#x2F;&#x2F;é”™è¯¯ä¿¡æ¯</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Handleå‡½æ•°é‡Œéœ€è¦é‡æ–°å®šä¹‰ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func (group *RouterGroup) Handle(method, uri string, handlers []HandlerFunc) &#123;</span><br><span class="line">   &#x2F;&#x2F;åŠ ä¸ŠåŸæœ¬è·¯ç”±ç»„çš„ è·¯å¾„</span><br><span class="line">   uris:&#x3D; path.Join(group.prefix, uri)</span><br><span class="line">   &#x2F;&#x2F;å°†æ–°æ¥çš„handleræ•´åˆ</span><br><span class="line">   handlers &#x3D; group.CombineHandlers(handlers)</span><br><span class="line">   &#x2F;&#x2F;å°† æ•´åˆçš„è·¯å¾„ è¿˜æœ‰ handler æ·»åŠ åˆ°httprouterå»</span><br><span class="line">   group.engine.router.Handle(method, uris, func(w http.ResponseWriter, req *http.Request, params httprouter.Params) &#123;</span><br><span class="line">      group.NewContext(w, req, params, handlers).Next()</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸åªæ˜¯è¦æŠŠHandlerFuncè®¾ç½®æˆåˆ‡ç‰‡å½¢å¼ï¼Œè¿˜éœ€è¦è€ƒè™‘åˆ°å°†å…ˆå»çš„ä¸ååŠ å…¥çš„handleè¿›è¡Œæ•´åˆã€‚</p>
<p>æ‰€ä»¥CombineHandlerså‡½æ•°åº”è¿è€Œç”Ÿã€‚</p>
<p>CombineHandlersä»£ç å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func (group *RouterGroup) CombineHandlers(handlers []HandlerFunc) []HandlerFunc &#123;</span><br><span class="line">	lens :&#x3D; len(group.Handlers) + len(handlers)</span><br><span class="line">	handlerss :&#x3D; make([]HandlerFunc,0, lens)</span><br><span class="line">	handlerss &#x3D; append(handlerss, group.Handlers...)</span><br><span class="line">	handlerss &#x3D; append(handlerss, handlers...)</span><br><span class="line">	return handlerss</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾è€Œæ˜“è§ï¼Œè¯¥å‡½æ•°ä½œç”¨å°±æ˜¯å°†å½“å‰çš„Handlerå’Œæ–°æ¥çš„handleræ•´åˆï¼Œå¹¶ä»¥åˆ‡ç‰‡çš„å½¢å¼è¿”å›ã€‚å› ä¸ºåé¢æœ‰Nextå‡½æ•°ä¼šå¸®åŠ©è¿›è¡Œéå†è¿™ä¸ªåˆ‡ç‰‡ï¼Œä¸€èˆ¬æ¥è¯´é™¤äº†æœ€åä¸€ä¸ªå‡½æ•°å…¶ä½™çš„éƒ½æ˜¯ä¸­é—´ä»¶ã€‚</p>
<p>ä¸Šé¢è¯´åˆ°äº†Nextå‡½æ•°ä¼šå¸®åŠ©è¿›è¡Œéå†åˆ‡ç‰‡ï¼Œå› ä¸ºç°åœ¨HandlerFuncæ˜¯ä¸ªåˆ‡ç‰‡äº†ï¼Œé‡Œé¢æœ‰å¤šä¸ªå‡½æ•°ï¼Œéœ€è¦ä¾æ¬¡éå†å¹¶æ‹¿å‡ºæ¥è°ƒç”¨ï¼Œä¸”éœ€è¦æ³¨æ„çš„æ˜¯ä¸€å®šè¦æŒ‰é¡ºåºéå†ï¼Œå¦‚æ­¤æ‰èƒ½è¾¾åˆ°ä¸­é—´ä»¶æ•ˆæœã€‚</p>
<p>è¯ä¸å¤šè¯´ï¼Œä¸Šä»£ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;è¿™ä¸ªæ—¶å€™éœ€è¦å°†silceä¸­çš„handerä¾æ¬¡å–å‡ºæ¥è°ƒç”¨</span><br><span class="line">func (c *Context) Next() &#123;</span><br><span class="line">   c.index++</span><br><span class="line">   &#x2F;&#x2F;   ä¸€èˆ¬æ¥è¯´ é™¤äº†æœ€åä¸€ä¸ªå‡½æ•°  å‰é¢çš„éƒ½æ˜¯ä¸­é—´ä»¶</span><br><span class="line">   s :&#x3D; int8(len(c.handlers))</span><br><span class="line">   for ; c.index &lt; s; c.index++ &#123;</span><br><span class="line">      c.handlers[c.index](c)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼ŒContexté‡Œçš„indexä¹Ÿå¯ä»¥è§£é‡Šäº†ï¼Œä¸ºä»€ä¹ˆNewcontextä¼šè®¾ç½®-1ä¹Ÿèƒ½è®²ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func (group *RouterGroup) NewContext(w http.ResponseWriter, req *http.Request, params httprouter.Params, handlers []HandlerFunc) *Context &#123;</span><br><span class="line">   return &amp;Context&#123;</span><br><span class="line">      Writer:  w,</span><br><span class="line">      Req:     req,</span><br><span class="line">      index:   -1,&#x2F;&#x2F; ç¬¬ä¸€æ¬¡å°±è®¾ç½®-1  è°ƒç”¨æ—¶åŒæ—¶ä¼šè°ƒç”¨next++</span><br><span class="line">      engine:  group.engine,</span><br><span class="line">      Params:  params,</span><br><span class="line">      handlers: handlers,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Contexté‡Œçš„indexå°±æ˜¯æ‹¿æ¥å¸®åŠ©Nextè¿›è¡Œéå†åˆ‡ç‰‡çš„ï¼Œæ¯æ¬¡æœ‰ä¸€ä¸ªGETæˆ–POSTç­‰çš„è·¯ç”±æ³¨å†Œè®¿é—®æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨NewContextï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯-1ï¼Œå¾ˆç®€å•ï¼ŒNextå‡½æ•°é‡Œä¼šæœ‰index++ã€‚</p>
<h2 id="åŠŸèƒ½"><a href="#åŠŸèƒ½" class="headerlink" title="åŠŸèƒ½"></a>åŠŸèƒ½</h2><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€äº›æ¡†æ¶åŠŸèƒ½ï¼Œå¦‚æˆ‘åœ¨ä»¥å‰ç”¨ä¸­é—´ä»¶çš„æ—¶å€™ç”¨setä»¥åŠgetå‡½æ•°è·å–ä¸­é—´å˜é‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; å­˜å‚¨ä¸­é—´å˜é‡</span><br><span class="line">func (c *Context) Set(key string, item interface&#123;&#125;) &#123;</span><br><span class="line">   if c.Keys &#x3D;&#x3D; nil &#123;</span><br><span class="line">      c.Keys &#x3D; make(map[string]interface&#123;&#125;)</span><br><span class="line">   &#125;</span><br><span class="line">   c.Keys[key] &#x3D; item</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¯»å–å­˜å‚¨çš„å˜é‡</span><br><span class="line">func (c *Context)Get(key string)interface&#123;&#125;&#123;</span><br><span class="line">   var ok bool</span><br><span class="line">   var item interface&#123;&#125;</span><br><span class="line">   &#x2F;&#x2F;å¦‚æœ  æ˜¯</span><br><span class="line">   if c.Keys !&#x3D; nil &#123;</span><br><span class="line">      item, ok &#x3D; c.Keys[key]</span><br><span class="line">   &#125; else &#123;</span><br><span class="line">      item, ok &#x3D; nil, false</span><br><span class="line">   &#125;</span><br><span class="line">   &#x2F;&#x2F; itemä¸ºç©º æˆ–è€… okä¸ºfalseçš„è¯è¯´æ˜å°±æ²¡æœ‰å˜é‡å­˜åœ¨</span><br><span class="line">   if !ok || item &#x3D;&#x3D; nil &#123;</span><br><span class="line">      log.Panicf(&quot;Key %s doesn&#39;t exist&quot;, key)</span><br><span class="line">   &#125;</span><br><span class="line">   return item</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æ˜¯åˆ©ç”¨äº†åœ¨Contexté‡Œé¢çš„keysæ•°æ®ç±»å‹ä¸ºmapä¿å­˜ã€‚åœ¨Setå‡½æ•°é‡Œå°±æ˜¯æŠŠContexté‡Œçš„keysç”¨mapå¯¹åº”èµ·æ¥ï¼Œå› ä¸ºvalueå¯ä»¥æ˜¯ä»»ä½•æ•°æ®æ‰€ä»¥å®šä¹‰çš„ç±»å‹ä¸ºæ¥å£ã€‚</p>
<p>æ‰€ä»¥å‘Contestæ·»åŠ æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Keys map[string]interface&#123;&#125;&#x2F;&#x2F;ç”¨mapå­˜å‚¨ä¸­é—´å˜é‡</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯Getå‡½æ•°ï¼Œéœ€è¦æŠŠå‰é¢åœ¨Contextä¿å­˜çš„å˜é‡æ‹¿å‡ºæ¥ï¼Œå½“ç„¶keyå¿…é¡»æ˜¯å·²ç»ä¿å­˜äº†çš„ï¼Œå¦‚æœä¸ºç©ºè¯´æ˜æ²¡æœ‰å˜é‡å­˜åœ¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line">func (c *Context) String(code int, msg string) &#123;</span><br><span class="line">	c.Writer.Header().Set(&quot;Content-Type&quot;, &quot;text&#x2F;plain&quot;)</span><br><span class="line">	c.Writer.WriteHeader(code)&#x2F;&#x2F;æŠŠçŠ¶æ€ç å‘é€åˆ°è¯·æ±‚å¤´?</span><br><span class="line">	&#x2F;&#x2F;åœ¨ç½‘ç«™ä¸Šæ‰“å°</span><br><span class="line">	_, _ &#x3D; c.Writer.Write([]byte(msg))</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è¿™ä¸ªJSONæˆ‘è‡ªå·±æ²¡å†™å‡ºæ¥ï¼Œæ˜¯è·Ÿç½‘ä¸Šå†™çš„ï¼Œçœ‹äº†ä¸‹ï¼Œæ˜¯è¯·æ±‚å¤´æœ‰å…³</span><br><span class="line">func (c *Context) JSON(code int, obj interface&#123;&#125;) &#123;</span><br><span class="line">	c.Writer.Header().Set(&quot;Content-Type&quot;, &quot;application&#x2F;json&quot;)</span><br><span class="line">	c.Writer.WriteHeader(code)</span><br><span class="line"></span><br><span class="line">	encoder :&#x3D; json.NewEncoder(c.Writer)</span><br><span class="line">	if err :&#x3D; encoder.Encode(obj); err !&#x3D; nil &#123;</span><br><span class="line">		http.Error(c.Writer, err.Error(), 500)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ‹¿å‚æ•°</span><br><span class="line">func (c *Context) PostForm(key string) string &#123;</span><br><span class="line">	return c.Req.FormValue(key)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;å°è£…çš„ä¸€äº›åŠŸèƒ½</span><br><span class="line">func (c *Context) Query(key string) string &#123;</span><br><span class="line">	return c.Req.URL.Query().Get(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (c *Context) SetHeader(key string, value string) &#123;</span><br><span class="line">	c.Writer.Header().Set(key, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (c *Context) Data(code int, data []byte) &#123;</span><br><span class="line">	_, _ &#x3D; c.Writer.Write(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (c *Context) HTML(code int, html string) &#123;</span><br><span class="line">	c.SetHeader(&quot;Content-Type&quot;, &quot;text&#x2F;html&quot;)</span><br><span class="line">	_, _ &#x3D; c.Writer.Write([]byte(html))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ˜¯æˆ‘å°è£…çš„ä¸€äº›åŠŸèƒ½ã€‚</p>
<h2 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">var (</span><br><span class="line">   dunno     &#x3D; []byte(&quot;???&quot;)</span><br><span class="line">   centerDot &#x3D; []byte(&quot;Â·&quot;)</span><br><span class="line">   dot       &#x3D; []byte(&quot;.&quot;)</span><br><span class="line">   slash     &#x3D; []byte(&quot;&#x2F;&quot;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;func Recovery() HandlerFunc &#123;</span><br><span class="line">&#x2F;&#x2F; return func(c *Context) &#123;</span><br><span class="line">&#x2F;&#x2F;    defer func() &#123;</span><br><span class="line">&#x2F;&#x2F;       if err :&#x3D; recover(); err !&#x3D; nil &#123;</span><br><span class="line">&#x2F;&#x2F;          message :&#x3D; fmt.Sprint(&quot;%s&quot;, err)</span><br><span class="line">&#x2F;&#x2F;          log.Printf(&quot;%s\n\n&quot;, trace(message))</span><br><span class="line">&#x2F;&#x2F;          c.Fail(http.StatusInternalServerError, &quot;Interanl server Error&quot;)</span><br><span class="line">&#x2F;&#x2F;       &#125;</span><br><span class="line">&#x2F;&#x2F;    &#125;()</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;    c.Next()</span><br><span class="line">&#x2F;&#x2F; &#125;</span><br><span class="line">&#x2F;&#x2F;&#125;</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;func trace(message string) interface&#123;&#125; &#123;</span><br><span class="line">&#x2F;&#x2F; var pcs [32]uintptr</span><br><span class="line">&#x2F;&#x2F; n :&#x3D; runtime.Callers(3, pcs[:])</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; var str strings.Builder</span><br><span class="line">&#x2F;&#x2F; str.WriteString(message + &quot;\nTraceback:&quot;)</span><br><span class="line">&#x2F;&#x2F; for _, pc :&#x3D; range pcs[:n] &#123;</span><br><span class="line">&#x2F;&#x2F;    fn :&#x3D; runtime.FuncForPC(pc)</span><br><span class="line">&#x2F;&#x2F;    file, line :&#x3D; fn.FileLine(pc)</span><br><span class="line">&#x2F;&#x2F;    str.WriteString(fmt.Sprintf(&quot;\n\t%s:%d&quot;, file, line))</span><br><span class="line">&#x2F;&#x2F; &#125;</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; return str.String()</span><br><span class="line">&#x2F;&#x2F;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; stack returns a nicely formated stack frame, skipping skip frames</span><br><span class="line">func stack(skip int) []byte &#123;</span><br><span class="line">   buf :&#x3D; new(bytes.Buffer) &#x2F;&#x2F; the returned data</span><br><span class="line">   &#x2F;&#x2F; As we loop, we open files and read them. These variables record the currently</span><br><span class="line">   &#x2F;&#x2F; loaded file.</span><br><span class="line">   var lines [][]byte</span><br><span class="line">   var lastFile string</span><br><span class="line">   for i :&#x3D; skip; ; i++ &#123; &#x2F;&#x2F; Skip the expected number of frames</span><br><span class="line">      pc, file, line, ok :&#x3D; runtime.Caller(i)</span><br><span class="line">      if !ok &#123;</span><br><span class="line">         break</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F; Print this much at least.  If we can&#39;t find the source, it won&#39;t show.</span><br><span class="line">      fmt.Fprintf(buf, &quot;%s:%d (0x%x)\n&quot;, file, line, pc)</span><br><span class="line">      if file !&#x3D; lastFile &#123;</span><br><span class="line">         data, err :&#x3D; ioutil.ReadFile(file)</span><br><span class="line">         if err !&#x3D; nil &#123;</span><br><span class="line">            continue</span><br><span class="line">         &#125;</span><br><span class="line">         lines &#x3D; bytes.Split(data, []byte&#123;&#39;\n&#39;&#125;)</span><br><span class="line">         lastFile &#x3D; file</span><br><span class="line">      &#125;</span><br><span class="line">      fmt.Fprintf(buf, &quot;\t%s: %s\n&quot;, function(pc), source(lines, line))</span><br><span class="line">   &#125;</span><br><span class="line">   return buf.Bytes()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func source(lines [][]byte, n int) []byte &#123;</span><br><span class="line">   n--</span><br><span class="line">   if n &lt; 0 || n &gt;&#x3D; len(lines) &#123;</span><br><span class="line">      return dunno</span><br><span class="line">   &#125;</span><br><span class="line">   return bytes.TrimSpace(lines[n])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func function(pc uintptr) []byte &#123;</span><br><span class="line">   fn :&#x3D; runtime.FuncForPC(pc)</span><br><span class="line">   if fn &#x3D;&#x3D; nil &#123;</span><br><span class="line">      return dunno</span><br><span class="line">   &#125;</span><br><span class="line">   name :&#x3D; []byte(fn.Name())</span><br><span class="line"></span><br><span class="line">   if lastslash :&#x3D; bytes.LastIndex(name, slash); lastslash &gt;&#x3D; 0 &#123;</span><br><span class="line">      name &#x3D; name[lastslash+1:]</span><br><span class="line">   &#125;</span><br><span class="line">   if period :&#x3D; bytes.Index(name, dot); period &gt;&#x3D; 0 &#123;</span><br><span class="line">      name &#x3D; name[period+1:]</span><br><span class="line">   &#125;</span><br><span class="line">   name &#x3D; bytes.Replace(name, centerDot, dot, -1)</span><br><span class="line">   return name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åªæœ‰åœ¨å»¶è¿Ÿå‡½æ•°å†…éƒ¨è°ƒç”¨Recoveræ‰æœ‰ç”¨ã€‚</span><br><span class="line">&#x2F;&#x2F; åœ¨å»¶è¿Ÿå‡½æ•°å†…è°ƒç”¨ recoverï¼Œ å¯ä»¥å–åˆ° panic çš„é”™è¯¯ä¿¡æ¯ï¼Œ</span><br><span class="line">&#x2F;&#x2F; å¹¶ä¸”åœæ­¢ panic ç»­å‘ï¼Œç¨‹åºè¿è¡Œæ¢å¤æ­£å¸¸</span><br><span class="line">func Recovery() HandlerFunc &#123;</span><br><span class="line">   return func(c *Context) &#123;</span><br><span class="line">      defer func() &#123;</span><br><span class="line">         if len(c.Errors) &gt; 0 &#123;</span><br><span class="line">            log.Println(c.Errors)</span><br><span class="line">         &#125;</span><br><span class="line">         if err :&#x3D; recover(); err !&#x3D; nil &#123;</span><br><span class="line">            stack :&#x3D; stack(3)</span><br><span class="line">            log.Printf(&quot;PANIC: %s\n%s&quot;, err, stack)</span><br><span class="line">            c.Writer.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;()</span><br><span class="line"></span><br><span class="line">      c.Next()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h1><h2 id="1-ç»“æ„ä½“çš„äº’ç›¸è°ƒç”¨"><a href="#1-ç»“æ„ä½“çš„äº’ç›¸è°ƒç”¨" class="headerlink" title="1.ç»“æ„ä½“çš„äº’ç›¸è°ƒç”¨"></a>1.ç»“æ„ä½“çš„äº’ç›¸è°ƒç”¨</h2><p>åœ¨æŸ¥çœ‹ginçš„æºç ï¼ŒRouterGroupä¸Engineäº’ç›¸æ˜¯å¯¹æ–¹çš„æˆå‘˜ã€‚äºæ˜¯æˆ‘æœ‰ä¸€ä¸ªç–‘æƒ‘ï¼Œå¦‚æ­¤çš„è¯ï¼Œä¾¿ä¼šæ— é™åˆ†é…å†…å­˜ä¸‹å»ï¼Œè‚¯å®šæ˜¯ä¸å¯èƒ½çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type B struct &#123;</span><br><span class="line">   *A</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type A struct &#123;</span><br><span class="line">   *B</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>ä¸æœ‹å‹äº¤è°ˆåå¾—ä»¥è§£å†³ã€‚</p>
<p>å¦‚æœæ˜¯æŒ‡é’ˆï¼Œaç»“æ„ä½“å†…å†™äº†å»æ‰¾bç»“æ„ä½“çš„åœ°å€ï¼Œbç»“æ„ä½“å†…å†™äº†å»æ‰¾açš„åœ°å€ï¼Œåœ¨è°ƒç”¨açš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šç»™Båˆ†é…å†…å­˜ï¼Œä½†ä¸ä¼šç»™Bçš„æˆå‘˜å˜é‡åˆ†é…å†…å­˜ï¼Œå°±ä¸ä¼šå¾ªç¯ã€‚æ‰€ä»¥ï¼Œå¦‚æœä¸æ˜¯æŒ‡é’ˆçš„è¯ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æŠ¥é”™ã€‚</p>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>å­æœ‹</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://example.com/2021/06/11/%E5%9F%BA%E4%BA%8E%20Go%20%E5%AE%9E%E7%8E%B0%E4%BB%BF%20gin%20%E6%A1%86%E6%9E%B6/" title="åŸºäº Go å®ç°ä»¿ gin æ¡†æ¶">http://example.com/2021/06/11/%E5%9F%BA%E4%BA%8E%20Go%20%E5%AE%9E%E7%8E%B0%E4%BB%BF%20gin%20%E6%A1%86%E6%9E%B6/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/06/11/sync.Map%20%E8%AF%A6%E8%A7%A3/" rel="prev" title="sync.Mapè¯¦è§£"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">sync.Mapè¯¦è§£</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/06/10/gorm%E6%8F%92%E5%85%A5%E6%89%B9%E9%87%8F%E6%95%B0%E6%8D%AE/" rel="next" title="gormæ’å…¥æ‰¹é‡æ•°æ®"><span class="post-nav-text">gormæ’å…¥æ‰¹é‡æ•°æ®</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 â€“ 2021 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> å­æœ‹</span></div><div class="powered"><span>Powered by <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> v5.3.0</span><span class="footer-separator">|</span><span>Theme - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.4.0</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>